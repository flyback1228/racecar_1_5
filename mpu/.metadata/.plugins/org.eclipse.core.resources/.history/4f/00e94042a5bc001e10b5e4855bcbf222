/*
 * mainpp.cpp
 *
 *  Created on: Oct 28, 2023
 *      Author: acsr2004
 */

#include "mainpp.h"
#include "main.h"

#include "stm32h7xx_hal.h"
#include "utility.h"
#include <stdio.h>
#include <cstring>
#include "jy901/JY901_Serial.h"

extern UART_HandleTypeDef huart7;
extern UART_HandleTypeDef huart8;

uint8_t jy901_data[11];

CJY901 jy901(&huart7);

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart){
	if(huart->Instance==UART8){

    	jy901.parseData(jy901_data);

    	HAL_UART_Receive_DMA(&huart8, jy901_data, 11);
	}
}

void HAL_UART_ErrorCallback(UART_HandleTypeDef *UartHandle) {
    if(UartHandle->Instance==UART8) {


    	HAL_UART_Receive_DMA(&huart8, jy901_data, 11);
    }
}

/*
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim){
	if(htim->Instance==TIM16){
		if(input_mode==Manual){
			esc_duty=0;
			servo_duty=0;
			__HAL_TIM_SetCompare(&htim3, TIM_CHANNEL_1,esc_duty);
			__HAL_TIM_SetCompare(&htim3, TIM_CHANNEL_2,servo_duty);
		}
	}
}*/


void setup(){
	DWT_Init();

	HAL_GPIO_WritePin(LED_YELLOW_GPIO_Port, LED_YELLOW_Pin, GPIO_PIN_SET);
	HAL_GPIO_WritePin(LED_RED_GPIO_Port, LED_RED_Pin, GPIO_PIN_RESET);
	HAL_UART_Receive_DMA(&huart8, jy901_data, 11);


}




void loop(){

	HAL_GPIO_TogglePin(LED_BLUE_GPIO_Port, LED_BLUE_Pin);
	HAL_UART_Transmit(&huart7, (uint8_t*)"Acc\n", 4, 100);
	printf("acc: %5.2f,%5.2f,%5.2f\n",jy901.getAccX(),jy901.getAccY(),jy901.getAccZ());

	HAL_Delay(1000);


}


